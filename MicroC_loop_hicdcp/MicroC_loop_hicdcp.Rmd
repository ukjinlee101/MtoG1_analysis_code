---
title: "R Notebook"
---
# LOADING REQUIREMENTS
## PACKAGES
```{r message=FALSE, warning=FALSE, include=FALSE}
# LIST OF PACKAGES
pkgs = c("tidyverse", "here", "svglite", "ggplot2", "ggrepel",
         "stringr", "BiocManager", "RColorBrewer", "viridis", "magick",
         "nlme", "factoextra", "devtools", "beepr", "remotes",
         "cowplot", "data.table", "strawr", "utils",
         "reshape2", "VennDiagram","gridExtra", "eulerr", "scales",
         "gplots", "locfdr", "future", "ggbeeswarm", "glossary", "scico")
bio_pkgs = c("biomaRt", "DESeq2", "ComplexHeatmap", "apeglm", "vsn",
             "rhdf5", "InteractionSet", "plotgardener", "HiCDCPlus",
             "GenomicInteractions", "LOLA", "AnnotationHub",
             "org.Mm.eg.db", "enrichplot", "DOSE", "clusterProfiler",
             "HiCExperiment", "HiCool", "HiContacts", "HiContactsData", "fourDNData", "DNAZooData",
             "MotifDb", "Biostrings", "rtracklayer", "InteractionSet",
             "BSgenome.Mmusculus.UCSC.mm10")

# INSTALL PACKAGES
# install.packages(pkgs)
# BiocManager::install(bio_pkgs)

# INSTALL HiC related packages
# remotes::install_github("robinweide/GENOVA")
# remotes::install_github("psyteachr/introdataviz")

# LOAD PACKAGES
lapply(pkgs, require, character.only = TRUE)
lapply(bio_pkgs, require, character.only = TRUE)
require(GENOVA)
require(introdataviz)
require(igraph)

# CLEANING
rm(pkgs, bio_pkgs)
options(scipen=999)


# Fixed HiCDC+
curDir <- "/Volumes/UKJIN_SSD"
curDir <- "/athena/apostoloulab/scratch/ukl4001"

source(here(curDir, "/MtoG1_analysis_code/script/hicdc2hic_custom.R"))

```

## COLOR PALETTE
```{r}
palette_1 = list(red = "#E9002D",
                 amber = "#FFAA00",
                 green = "#00B000")
palette_2 = list(red = "#FF1F5B",
                 green = "#00CD6C",
                 blue = "#009ADE",
                 purple = "#AF58BA",
                 yellow = "#FFC61E",
                 orange = "#F28522",
                 grey = "#A0B1BA",
                 brown = "#A6761D")
palette_3 = list(grey1 = "#a0b1ba",
                 grey2 = "#c5d0d5",
                 grey3 = "#eceff1")

colorListLoop <-  c(palette_3[["grey3"]], palette_3[["grey2"]], palette_3[["grey1"]],
                     "#C5E1EF", "#6CB0D6", "#226E9C",
                     "#06592A", 
                     "#FED976", "#FD8D3C", "#E31A1C")
colorListPromoter <- c(palette_3[["grey3"]],"#E88587", "#E31A1C")
colorListEnhancer <- c(palette_3[["grey3"]],"#87AFC7", "#226E9C")
colorListStructure <- c(palette_3[["grey3"]], palette_3[["grey2"]], palette_3[["grey1"]])
```

## DIR LIST
```{r}
hicDir <- here(curDir, "data/hic_pooled")
loopDir <- here(curDir, "data/loop_hicdcp")
figDir <- here(curDir, "figure/loop_hicdcp")
refDir <- here(curDir, "MtoG1_analysis_code/reference")
rdsDir <- here(curDir, "data/rds")
dir.create(loopDir, showWarnings = FALSE)
dir.create(figDir, showWarnings = FALSE)
dir.create(rdsDir, showWarnings = FALSE)

```

## FIGURE PARAMETERS
```{r}
library(colorspace)

fontType <- "Helvetica"

fontSizeL <- 10 # pt
fontSizeM <- 8
fontSizeS <- 6

lineThick <- 0.75 # pt
lineMedium <- 0.5
lineThin <- 0.25

panelUnit <- 30 # mm
panelMargin <- 1.5

mmToInch <- 0.03937007874
mmToLineUnit <- 1/2.13
mmToLinePlotgarden <- 1/0.75
ptToMM <- 1/2.845


strong_red <- "#CB333A"
strong_blue <- "#4851A0"
weak_red <- lighten(strong_red, amount = 0.4)   # FF7D81
weak_blue <- lighten(strong_blue, amount = 0.4) # 8A91DD
no_grey <- "#A8A8A8"

strong_teel <- "#0892A5"
strong_green <- "#23CE6B" # A485
strong_darkgreen <- "#054A29"
strong_yellow <- "#FFBA49"
strong_orange <- "#F18F01" # dTAG
strong_lightpurple <- "#BD93D8"
strong_purple <- "#9E33CB" # Epi

panelSize <- function(num, unit = panelUnit, margin = panelMargin){
  return(num*unit - 2*margin)
}

```

# HiCDC+ (Run on cluster)
In the standard workflow, one first needs to generate genomic features present in the HiCDCPlus model (GC content, mappability, effective length) using the construct_features function (see Creating genomic feature files). This can be either done for uniformly or multiple restriction fragment binned data.
HiCDCPlus stores counts and features in a memory-efficient way using what we name as a gi_list instance(see The gi_list instance). One next feeds the genomic features in the form of a gi_list instance using generate_bintolen_gi_list function. Then, counts can be added to this gi_list instance using dedicated functions for each input Hi-C file format (add_hic_counts, add_hicpro_matrix_counts,add_hicpro_allvalidpairs.counts).

```{r}
# for(res in c(10, 5)){
#   for(sample in c("G1DMSO_pooled", "G1dTAG_pooled", "G1A485_pooled")){
    
for(res in c(5)){
  for(sample in c("G1A485_pooled")){
    
    if(!file.exists(here(loopDir, paste0("mm10_", res, "kb_RE_agnostic_bins_uniform_bintolen.txt.gz")))){
      construct_features_parallel(output_path = here(loopDir, paste0("mm10_", res, "kb_RE_agnostic_bins_uniform")),
                                  gen = 'Mmusculus',
                                  gen_ver = 'mm10',
                                  feature_type = 'RE-agnostic', bin_type = 'Bins-uniform', binsize = res * 1000,
                                  wg_file = here(refDir, "ATAC", "GSM3106257_ATAC_1_blacklistMasked.bw"),
                                  ncore = 8)
    }
    
    gi_list <- generate_bintolen_gi_list(
      bintolen_path = here(loopDir, paste0("mm10_", res, "kb_RE_agnostic_bins_uniform_bintolen.txt.gz")),
      Dthreshold = 2e+06,
      binned = TRUE, binsize = res * 1000,
      gen = 'Mmusculus',
      gen_ver = 'mm10')
    
    # Add HiC count
    gi_list <- add_hic_counts(gi_list, hic_path = here(hicDir, paste0(sample, "_allRes.hic")))
    
    # Expand features for modeling
    gi_list <- expand_1D_features(gi_list)
    
    # saving gi_list for backup
    saveRDS(gi_list, here(rdsDir, paste0("gi_list_", sample, "_", res, "kb.rds")))
    
    # Run HiC-DC+ 
    set.seed(123) #HiC-DC downsamples rows for modeling
    gi_list <- HiCDCPlus(gi_list,
                         distance_type = "spline",
                         binned = TRUE)
    saveRDS(gi_list, here(rdsDir, paste0("gi_list_", sample, "_", res, "kb_hicdcplus.rds")))
    
    head(gi_list)
    
    hicdc2hic_custom(gi_list,hicfile=here(loopDir, paste0(sample, "_", res, "kb_hicdcplus_obsexp.hic")),
                     mode='normcounts',gen_ver='mm10')
    hicdc2hic_custom(gi_list,hicfile=here(loopDir, paste0(sample, "_", res, "kb_hicdcplus_zscore.hic")),
                     mode='zvalue',gen_ver='mm10')
    hicdc2hic_custom(gi_list,hicfile=here(loopDir, paste0(sample, "_", res, "kb_hicdcplus_minuslog10pval.hic")),
                     mode='pvalue',gen_ver='mm10')
    hicdc2hic_custom(gi_list,hicfile=here(loopDir, paste0(sample, "_", res, "kb_hicdcplus_minuslog10qval.hic")),
                     mode='qvalue',gen_ver='mm10')
    
    gi_list_write(gi_list,fname=here(loopDir, paste0(sample, "_", res, "kb_hicdcplus.txt.gz")))
    
    cutoff <- 0.001
    gi_list_filtered <- lapply(gi_list, function(gi) {
      gi[ mcols(gi)$qvalue <  cutoff]
    })
    
    df_list <- lapply(gi_list_filtered, as.data.frame)
    
    # Combine into one big data.frame
    combined_df <- do.call(rbind, df_list)
    
    # Write to a tab-delimited file
    ####### column coordinates needs to be double checked
    fwrite(combined_df %>% dplyr::select(c(1, 2, 3, 8, 9, 10, 16, 21, 22)),
           quote = FALSE, row.names = FALSE, col.names = FALSE,
           sep = "\t",
           file = here(loopDir, paste0(sample, "_", res, "kb_hicdcplus_qval", 0.0005, ".bedpe")))
    
    rm(combined_df, df_list, gi_list, gi_list_filtered)
  }
}
```

# Testing cutoff (Run on cluster)
```{r}
res <- 10
for (res in c(10, 5)){
  for(sample in c("G1DMSO_pooled", "G1dTAG_pooled", "G1A485_pooled")){
    gi_list <- gi_list_read(fname = here(loopDir, paste0(sample, "_", res, "kb_hicdcplus.txt.gz")))
    
    cutoffs <- c(0.1, 0.05, 0.01, 0.005, 0.001, 0.0005, 0)
    
    for(i in seq_len(length(cutoffs) - 1)) {
      upper <- cutoffs[i]
      lower <- cutoffs[i + 1]
      
      
      gi_list_filtered <- lapply(gi_list, function(gi) {
        qv <- mcols(gi)$qvalue
        gi[qv < upper & qv >= lower]
      })
      
      df_list <- lapply(gi_list_filtered, as.data.frame)
      
      # Combine into one big data.frame
      combined_df <- do.call(rbind, df_list)
      
      # Write to a tab-delimited file
      
      fwrite(combined_df %>% dplyr::select(c(1, 2, 3, 6, 7, 8, 12, 13, 14)),
             quote = FALSE, row.names = FALSE, col.names = FALSE,
             sep = "\t",
             file = here(loopDir, paste0("testing_", sample, "_", res, "kb_hicdcplus_qval", upper, "_", lower, ".bedpe")))
    }
    rm(gi_list)
  }
}
```


